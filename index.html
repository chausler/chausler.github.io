<!DOCTYPE html>
<html>

<head>
    <style>
        .target {
            float: left;
            width: 80%;
            height: auto;
            min-height: 120px;
            min-width: 120px;
            margin: 10px;
            padding: 10px;
            border: 1px solid rgb(195, 28, 28);
        }

        img {
            width: 120px;
            height: 120px;
            /* padding: 2px; */
        }

        /*
.target {
  width: 80%;
} */

        .main {
            margin-left: 280px;
        }

        /* Header/Logo Title */
        .header {
            padding: 60px;
            text-align: center;
            background: #1abc9c;
            color: white;
            /* font-size: 30px; */
            height: 100px;
            margin-left: 280px;
        }

        .sidebar {
            height: 100%;
            width: 250px;
            top: 0;
            left: 0;
            padding: 10px;
            margin: 10px;
            position: fixed;
            background-color: rgb(99, 114, 114);
            padding-top: 20px;
            overflow: auto
        }

        .wave {
            display: inline-block;
            padding: 2px;
        }

        .static {
            position: absolute;
            background: white;
        }

        .static:hover {
            opacity: 0;
        }
    </style>

</head>

<body>
    <div class="header">
        <h1>Review Unpublished Sessions</h1>
        <p> Select a session to review:
            <select id="selectSession">

            </select>
            <button onclick="selectSession()">Load Waves</button>
        </p>


        <button onclick="saveDraftClick()">Save Session Draft</button>
        <button onclick="saveAndPublishClick()">Save Session & Publish</button>
        <p id="results"></p>
    </div>

    <div>
        <div id="sidebar_div" class="sidebar">
            <p3>Holding Place for unassigned surfs</p3>
        </div>
        <div id="main_div" class="main">
        </div>
    </div>
</body>


<script>

    function removeAllChildNodes(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }

    function loadWaves(query_string) {

        const sidebar_div = document.getElementById('sidebar_div');
        sidebar_div.addEventListener("dragover", allowDrop);
        sidebar_div.addEventListener("drop", drop);
        const main_div = document.getElementById('main_div');
        const list = document.createDocumentFragment();

        removeAllChildNodes(sidebar_div);
        removeAllChildNodes(main_div);

        const url = "https://xqmp-ydra-x0sy.a2.xano.io/api:kYaePrLu:v1/Admin/GetSession" + query_string
        fetch(url)
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                let surfers = data;
                var surfer_div;

                surfers.Persons.map(function (surfer) {
                    if (surfer.person_id.includes("999__")) {
                        surfer_div = sidebar_div;
                    } else {
                        surfer_div = document.createElement('div');
                        surfer_div.id = Math.random().toString(36).substring(2, 16);
                        surfer_div.classList.add("target");
                        surfer_div.addEventListener("dragover", allowDrop);
                        surfer_div.addEventListener("drop", drop);
                    }
                    surfer.Waves.map(function (wave) {
                        let wave_span = document.createElement('span');
                        wave_span.draggable = true;
                        wave_span.addEventListener("dragstart", drag);
                        wave_span.id = wave.wave_id
                        wave_span.classList.add('wave')

                        let static_img = document.createElement('img');
                        static_img.src = wave.Thumbnail.detected_person_thumbnail.replace('.gif', '_000.jpg')
                        static_img.draggable = false;
                        static_img.classList.add('static')

                        let active_img = document.createElement('img');
                        active_img.src = wave.Thumbnail.detected_person_thumbnail
                        active_img.draggable = false;
                        active_img.classList.add('active')

                        wave_span.appendChild(static_img)
                        wave_span.appendChild(active_img)

                        surfer_div.appendChild(wave_span);

                    });
                    if (!surfer.person_id.includes("999__")) {
                        main_div.append(surfer_div)
                    }
                });
                var num_surfers_loaded = surfers.Persons.length;
                var target_surfer_slots = 22;
                var new_blank_slots = target_surfer_slots - num_surfers_loaded;
                if (num_surfers_loaded < target_surfer_slots) {
                    for (let i = 0; i < new_blank_slots; i++) {
                        surfer_div = document.createElement('div');
                        surfer_div.id = Math.random().toString(36).substring(2, 10);
                        surfer_div.classList.add("target");
                        surfer_div.addEventListener("dragover", allowDrop);
                        surfer_div.addEventListener("drop", drop);
                        main_div.append(surfer_div)
                    }
                }
            })
            .catch(function (error) {
                console.log(error);
            });


    }

    const unpublished_url = "https://xqmp-ydra-x0sy.a2.xano.io/api:kYaePrLu:v1/list_unpublished_sessions"
    fetch(unpublished_url).then((response) => {
        return response.json();
    })
        .then((data) => {
            let sessions = data;
            let selectElement = document.querySelector('#selectSession');
            sessions.map(function (session) {
                let session_text = `${session.StartDateLocal},  ${session.StartHourLocal}:00 =>  ${session.Side}`;
                let session_value = `?Hour=${session.StartHourLocal}&Date=${session.StartDateLocal}&pool_zone=${session.Side}`;
                let session_option = document.createElement('option');
                session_option.value = session_value;
                session_option.innerText = session_text;
                selectElement.appendChild(session_option);

            });

        });

    function selectSession() {
        selectElement = document.querySelector('#selectSession');
        selected_session = selectElement.value;
        loadWaves(selected_session);
        // document.querySelector('.output').textContent = selected_session;
    }

    function saveAndPublishClick() {
        let text;
        if (confirm("Are you sure you want to publish?\nThis can't be undone! ") == true) {
            text = "You pressed OK!";
        } else {
            text = "You canceled!";
        }
    }

    function saveDraftClick() {
        const surfers = document.getElementsByClassName("target");
        const surfers_array = [...surfers];
        var results = [];
        surfers_array.map(function (surfer) {
            const waves = [];
            const waves_array = [...surfer.childNodes];
            waves_array.map(function (wave) {
                waves.push(wave.id);
            });

            if (waves.length > 0) {
                const surfer_waves = {};
                surfer_waves["surfer_session_id"] = surfer.id;
                surfer_waves["waves"] = waves;
                results.push(surfer_waves);
            }

        });
        console.log(results);
        document.getElementById("results").innerHTML = JSON.stringify(results, undefined, 2);
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        if (ev.target.nodeName == "IMG") {
            if (ev.target.parentNode.parentNode.nodeName == "DIV") {
                ev.target.parentNode.parentNode.appendChild(document.getElementById(data));
            }
        } else if (ev.target.nodeName == "SPAN") {
            if (ev.target.parentNode.nodeName == "DIV") {
                ev.target.parentNode.appendChild(document.getElementById(data));
            }
        }
        else if (ev.target.nodeName == "DIV") {
            ev.target.appendChild(document.getElementById(data));
        }

    }




    // sidebar.appendChild(list);



</script>

</html>
